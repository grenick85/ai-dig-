import os
from trend_detection import get_trending_topics
from ai_content_generation import generate_outline, generate_ebook
from auto_upload_gumroad import upload_product_to_gumroad
from marketing import post_to_twitter

def main():
    # 1. Detect trends
    twitter_trends, reddit_trends = get_trending_topics()
    topic = twitter_trends[0] if twitter_trends else (reddit_trends[0] if reddit_trends else "AI Digital Products")

    # 2. Generate content
    outline = generate_outline(topic)
    ebook = generate_ebook(topic, outline)
    os.makedirs("output", exist_ok=True)
    ebook_path = f"output/{topic.replace(' ', '_')}_ebook.txt"
    with open(ebook_path, "w") as f:
        f.write(ebook)

    # 3. Upload to Gumroad
    api_key = os.getenv("GUMROAD_API_KEY")
    description = f"E-book about {topic}, generated by AI."
    price = 500  # e.g., $5.00
    upload_resp = upload_product_to_gumroad(api_key, topic, description, price, ebook_path)
    gumroad_link = upload_resp.get('product', {}).get('short_url', '[Gumroad]')

    # 4. Post to Twitter
    tweet = f"New AI-generated e-book: '{topic}' now available! {gumroad_link}"
    bearer_token = os.getenv("TWITTER_BEARER_TOKEN")
    print(post_to_twitter(bearer_token, tweet))

if __name__ == "__main__":
    main()
